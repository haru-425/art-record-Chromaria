<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç”»æè¨˜éŒ²ã‚¢ãƒ—ãƒª</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <link rel="icon" href="icon-192.png" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 1em;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 1em;
    }
    h1 {
      font-size: 1.6em;
      color: #3b82f6;
    }
    input, select, textarea, button {
      width: 100%;
      margin-top: 0.3em;
      padding: 0.6em;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    button {
      background: #3b82f6;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #2563eb;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    .toolbar input {
      flex: 1;
    }
    #list {
      display: grid;
      gap: 1em;
    }
    .item {
      background: white;
      border-radius: 12px;
      padding: 1em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .thumb {
      width: 100%;
      max-height: 180px;
      object-fit: cover;
      border-radius: 8px;
    }
    .tag {
      display: inline-block;
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 6px;
      padding: 0.1em 0.5em;
      margin-right: 0.3em;
      font-size: 0.9em;
    }
    footer {
      text-align: center;
      margin-top: 2em;
      color: #888;
      font-size: 0.8em;
    }
  </style>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
</head>

<body>
  <header>
    <h1>ğŸ¨ ç”»æè¨˜éŒ²ã‚¢ãƒ—ãƒª</h1>
    <p>ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã‚‹å®‰å…¨ãªãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªï¼ˆPWAå¯¾å¿œï¼‰</p>
  </header>

  <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <section id="formSection">
    <input id="name" placeholder="ç”»æåï¼ˆä¾‹ï¼šãƒ›ãƒ«ãƒ™ã‚¤ãƒ³ æ°´å½© #33ï¼‰" />
    <select id="category">
      <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
      <option value="çµµå…·">çµµå…·</option>
      <option value="ç­†">ç­†</option>
      <option value="ç´™">ç´™</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
    <input id="tags" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼šä¾‹ã€é’,é€æ˜æ°´å½©ã€ï¼‰" />
    <textarea id="note" placeholder="ãƒ¡ãƒ¢ï¼ˆä½¿ç”¨æ„Ÿãªã©ï¼‰"></textarea>
    <input id="image" type="file" accept="image/*" />
    <button id="add">è¿½åŠ </button>
    <button id="clear">å…¨å‰Šé™¤</button>
    <hr />
  </section>

  <!-- æ¤œç´¢ãƒ»æ“ä½œãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div class="toolbar">
    <input id="search" placeholder="ğŸ” æ¤œç´¢ï¼ˆåå‰ãƒ»ã‚¿ã‚°ãƒ»ãƒ¡ãƒ¢ï¼‰" />
    <button id="export">ğŸ’¾ JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <input id="importFile" type="file" accept=".json" style="display:none">
    <button id="import">ğŸ“‚ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  </div>

  <div id="list"></div>

  <footer>
    <p>Â© 2025 ç”»æè¨˜éŒ²ã‚¢ãƒ—ãƒª â€” ãƒ‡ãƒ¼ã‚¿ã¯ã‚ãªãŸã®ç«¯æœ«ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
  </footer>

  <script>
    // IndexedDB ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const dbName = "artRecordDB";
    let db;

    const openDB = () => {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(dbName, 1);
        req.onupgradeneeded = e => {
          const db = e.target.result;
          db.createObjectStore("images");
        };
        req.onsuccess = e => {
          db = e.target.result;
          resolve(db);
        };
        req.onerror = reject;
      });
    };

    const saveImage = async (id, file) => {
      const bitmap = await createImageBitmap(file);
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const scale = 400 / Math.max(bitmap.width, bitmap.height);
      canvas.width = bitmap.width * scale;
      canvas.height = bitmap.height * scale;
      ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
      return new Promise(resolve => {
        const tx = db.transaction("images", "readwrite");
        tx.objectStore("images").put(dataUrl, id);
        tx.oncomplete = () => resolve();
      });
    };

    const getImage = id =>
      new Promise(resolve => {
        const tx = db.transaction("images");
        const req = tx.objectStore("images").get(id);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
      });

    const deleteImage = id =>
      new Promise(resolve => {
        const tx = db.transaction("images", "readwrite");
        tx.objectStore("images").delete(id);
        tx.oncomplete = resolve;
      });

    // localStorage ãƒ‡ãƒ¼ã‚¿
    let data = JSON.parse(localStorage.getItem("artTools") || "[]");
    const saveData = () =>
      localStorage.setItem("artTools", JSON.stringify(data));

    const listEl = document.getElementById("list");
const render = async (filter = "") => {
  listEl.innerHTML = "";

  // é‡è¤‡é˜²æ­¢ã®ãŸã‚ã€ä¸€æ„ãªIDã‚»ãƒƒãƒˆã‚’ä½¿ã†
  const displayed = new Set();

  // å¤§æ–‡å­—å°æ–‡å­—ã‚’ç„¡è¦–ã—ã¦æ¤œç´¢
  const keyword = filter.trim().toLowerCase();

  for (const item of data) {
    // ã™ã§ã«è¡¨ç¤ºæ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
    if (displayed.has(item.id)) continue;

    // æ¤œç´¢æ¡ä»¶ãŒã‚ã‚‹å ´åˆã€åå‰ãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚°ã‚’ã¾ã¨ã‚ã¦åˆ¤å®š
    if (keyword) {
      const textFields = [
        item.name,
        item.note,
        ...(item.tags || [])
      ].join(" ").toLowerCase();

      if (!textFields.includes(keyword)) continue;
    }

    displayed.add(item.id);

    const div = document.createElement("div");
    div.className = "item";

    const imgUrl = item.imageId ? await getImage(item.imageId) : null;

    div.innerHTML = `
      ${imgUrl ? `<img src="${imgUrl}" class="thumb">` : ""}
      <h3>${item.name}</h3>
      <p>ã‚«ãƒ†ã‚´ãƒªï¼š${item.category || "æœªè¨­å®š"}</p>
      <div>${item.tags.map(t => `<span class="tag">${t}</span>`).join("")}</div>
      <p>${item.note || ""}</p>
      <button onclick="removeItem('${item.id}')">å‰Šé™¤</button>
      <button onclick="downloadItem('${item.id}')">å€‹åˆ¥ä¿å­˜</button>
    `;

    listEl.appendChild(div);
  }
};

    // å‰Šé™¤
    async function removeItem(id) {
      const i = data.findIndex(x => x.id === id);
      if (i >= 0) {
        if (data[i].imageId) await deleteImage(data[i].imageId);
        data.splice(i, 1);
        saveData();
        render();
      }
    }

    // å€‹åˆ¥ JSON ä¿å­˜
    async function downloadItem(id) {
      const item = data.find(x => x.id === id);
      const json = { ...item };
      json.image = item.imageId ? await getImage(item.imageId) : null;
      const blob = new Blob([JSON.stringify(json, null, 2)], {
        type: "application/json"
      });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${item.name}.json`;
      a.click();
    }

    // è¿½åŠ 
    document.getElementById("add").onclick = async () => {
      const name = document.getElementById("name").value.trim();
      if (!name) return alert("ç”»æåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      const item = {
        id: crypto.randomUUID(),
        name,
        category: document.getElementById("category").value,
        tags: document.getElementById("tags").value.split(",").map(t => t.trim()).filter(Boolean),
        note: document.getElementById("note").value,
        imageId: null
      };
      const file = document.getElementById("image").files[0];
      if (file) {
        item.imageId = crypto.randomUUID();
        await saveImage(item.imageId, file);
      }
      data.push(item);
      saveData();
      render();
      document.querySelectorAll("#formSection input, #formSection textarea").forEach(el => el.value = "");
    };

    document.getElementById("clear").onclick = async () => {
      if (!confirm("ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      for (const item of data) {
        if (item.imageId) await deleteImage(item.imageId);
      }
      data = [];
      saveData();
      render();
    };

    document.getElementById("search").oninput = e => render(e.target.value);

    // JSON ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    document.getElementById("export").onclick = async () => {
      const all = [];
      for (const item of data) {
        const img = item.imageId ? await getImage(item.imageId) : null;
        all.push({ ...item, image: img });
      }
      const blob = new Blob([JSON.stringify(all, null, 2)], {
        type: "application/json"
      });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "art-record-export.json";
      a.click();
    };

    // JSON ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    document.getElementById("import").onclick = () =>
      document.getElementById("importFile").click();

    document.getElementById("importFile").onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const arr = JSON.parse(text);
      for (const item of arr) {
        if (item.image) {
          item.imageId = crypto.randomUUID();
          await new Promise(res => {
            const tx = db.transaction("images", "readwrite");
            tx.objectStore("images").put(item.image, item.imageId);
            tx.oncomplete = res;
          });
          delete item.image;
        }
        data.push(item);
      }
      saveData();
      render();
      alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼");
    };

    // åˆæœŸåŒ–
    openDB().then(() => render());
  </script>
</body>
</html>
